services:
  traefik:
    image: traefik
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--api.dashboard=true"
      - "--api.insecure=true" 
    ports:
      - "80:80"
      - "8080:8080"  # dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backend

  frontend:
    build:
      context: ./ploshtadka-frontend
      args:
        VITE_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
        VITE_TURNSTILE_SITE_KEY: ${VITE_TURNSTILE_SITE_KEY}
    networks:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend-svc.loadbalancer.server.port=3000"

  admin-panel:
    build: ./ploshtadka-admin-panel
    networks:
      - backend
    environment:
      VITE_BASENAME: "/admin"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=PathPrefix(`/admin`)"
      - "traefik.http.routers.admin.entrypoints=web"
      - "traefik.http.middlewares.admin-strip.stripprefix.prefixes=/admin"
      - "traefik.http.routers.admin.middlewares=admin-strip"
      - "traefik.http.services.admin-svc.loadbalancer.server.port=3000"

  users-ms:
    build: ./ploshtadka-users-ms
    environment:
      DB_URL: ${DB_URL:-postgres://ploshtadka:ploshtadka@db:5432/ploshtadka}
      SECRET_KEY: ${SECRET_KEY:-change-me-in-production}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-120}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      CONTACT_EMAIL: ${CONTACT_EMAIL}
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY}
      FORWARDED_ALLOW_IPS: "*"
    networks:
      - backend
    depends_on:
      - db
      - redis
    labels:
      - "traefik.enable=true"
      # strip /api prefix before forwarding
      - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/api"
      # forwardAuth middleware (internal URL — no /api prefix)
      - "traefik.http.middlewares.jwt-auth.forwardauth.address=http://users-ms:8000/auth/verify"
      - "traefik.http.middlewares.jwt-auth.forwardauth.authResponseHeaders=X-User-Id,X-User-Scopes,X-Username"
      # no auth
      - "traefik.http.routers.users-public.rule=PathPrefix(`/api/auth`) || (Method(`POST`) && PathPrefix(`/api/users`)) || Method(`OPTIONS`)"
      - "traefik.http.routers.users-public.entrypoints=web"
      - "traefik.http.routers.users-public.middlewares=api-strip"
      - "traefik.http.routers.users-public.service=users-ms-svc"
      # protected
      - "traefik.http.routers.users-protected.rule=PathPrefix(`/api/users`) || PathPrefix(`/api/scopes`)"
      - "traefik.http.routers.users-protected.entrypoints=web"
      - "traefik.http.routers.users-protected.middlewares=jwt-auth,api-strip"
      - "traefik.http.routers.users-protected.service=users-ms-svc"
      # service def
      - "traefik.http.services.users-ms-svc.loadbalancer.server.port=8000"

  venues-ms:
    build: ./ploshtadka-venues-ms
    environment:
      DB_URL: ${DB_URL:-postgres://ploshtadka:ploshtadka@db:5432/ploshtadka}
      USERS_MS_URL: ${USERS_MS_URL:-http://users-ms:8000}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      FORWARDED_ALLOW_IPS: "*"
    networks:
      - backend
    depends_on:
      - db
    labels:
      - "traefik.enable=true"
      # no auth: read-only venue browsing + OPTIONS preflight
      - "traefik.http.routers.venues-public.rule=(Method(`GET`) || Method(`OPTIONS`)) && PathPrefix(`/api/venues`)"
      - "traefik.http.routers.venues-public.entrypoints=web"
      - "traefik.http.routers.venues-public.middlewares=api-strip"
      - "traefik.http.routers.venues-public.service=venues-svc"
      - "traefik.http.routers.venues-public.priority=10"
      # protected: POST / PATCH / DELETE on /venues
      - "traefik.http.routers.venues.rule=PathPrefix(`/api/venues`)"
      - "traefik.http.routers.venues.entrypoints=web"
      - "traefik.http.routers.venues.middlewares=jwt-auth,api-strip"
      - "traefik.http.routers.venues.service=venues-svc"
      - "traefik.http.routers.venues.priority=5"
      # service
      - "traefik.http.services.venues-svc.loadbalancer.server.port=8001"

  bookings-ms:
    build: ./ploshtadka-bookings-ms
    environment:
      DB_URL: ${DB_URL:-postgres://ploshtadka:ploshtadka@db:5432/ploshtadka}
      USERS_MS_URL: ${USERS_MS_URL:-http://users-ms:8000}
      VENUES_MS_URL: ${VENUES_MS_URL:-http://venues-ms:8001}
      PAYMENTS_MS_URL: ${PAYMENTS_MS_URL:-http://payments-ms:8003}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      FORWARDED_ALLOW_IPS: "*"
    networks:
      - backend
    depends_on:
      - db
      - redis
    labels:
      - "traefik.enable=true"
      # no auth: OPTIONS preflight
      - "traefik.http.routers.bookings-public.rule=Method(`OPTIONS`) && PathPrefix(`/api/bookings`)"
      - "traefik.http.routers.bookings-public.entrypoints=web"
      - "traefik.http.routers.bookings-public.middlewares=api-strip"
      - "traefik.http.routers.bookings-public.service=bookings-svc"
      - "traefik.http.routers.bookings-public.priority=10"
      # protected
      - "traefik.http.routers.bookings.rule=PathPrefix(`/api/bookings`)"
      - "traefik.http.routers.bookings.entrypoints=web"
      - "traefik.http.routers.bookings.middlewares=jwt-auth,api-strip"
      - "traefik.http.routers.bookings.service=bookings-svc"
      - "traefik.http.routers.bookings.priority=5"
      - "traefik.http.services.bookings-svc.loadbalancer.server.port=8002"

  payments-ms:
    build: ./ploshtadka-payments-ms
    env_file: .env
    environment:
      DB_URL: ${DB_URL:-postgres://ploshtadka:ploshtadka@db:5432/ploshtadka}
      BOOKINGS_MS_URL: ${BOOKINGS_MS_URL:-http://bookings-ms:8002}
      FORWARDED_ALLOW_IPS: "*"
      STRIPE_SUCCESS_URL: ${STRIPE_SUCCESS_URL:-http://localhost/bookings?payment=success}
      STRIPE_CANCEL_URL: ${STRIPE_CANCEL_URL:-http://localhost/bookings?payment=cancelled}
      STRIPE_CHECKOUT_EXPIRES_MINUTES: ${STRIPE_CHECKOUT_EXPIRES_MINUTES:-30}
    networks:
      - backend
    depends_on:
      - db
    labels:
      - "traefik.enable=true"
      # PUBLIC: Stripe webhook — must not require JWT (Stripe cannot provide one)
      # Priority 20 ensures this matches before the protected catch-all below
      - "traefik.http.routers.payments-webhook.rule=Method(`POST`) && Path(`/api/payments/webhook`)"
      - "traefik.http.routers.payments-webhook.entrypoints=web"
      - "traefik.http.routers.payments-webhook.middlewares=api-strip"
      - "traefik.http.routers.payments-webhook.service=payments-svc"
      - "traefik.http.routers.payments-webhook.priority=20"
      # PUBLIC: OPTIONS preflight
      - "traefik.http.routers.payments-public.rule=Method(`OPTIONS`) && PathPrefix(`/api/payments`)"
      - "traefik.http.routers.payments-public.entrypoints=web"
      - "traefik.http.routers.payments-public.middlewares=api-strip"
      - "traefik.http.routers.payments-public.service=payments-svc"
      - "traefik.http.routers.payments-public.priority=10"
      # Protected: all other /payments routes require JWT
      - "traefik.http.routers.payments.rule=PathPrefix(`/api/payments`)"
      - "traefik.http.routers.payments.entrypoints=web"
      - "traefik.http.routers.payments.middlewares=jwt-auth,api-strip"
      - "traefik.http.routers.payments.service=payments-svc"
      - "traefik.http.routers.payments.priority=5"
      - "traefik.http.services.payments-svc.loadbalancer.server.port=8003"

  redis:
    image: redis:7-alpine
    networks:
      - backend

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ploshtadka
      POSTGRES_USER: ploshtadka
      POSTGRES_PASSWORD: ploshtadka
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - backend

  pgadmin:
    image: dpage/pgadmin4
    restart: always
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - backend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=PathPrefix(`/pgadmin`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.services.pgadmin-svc.loadbalancer.server.port=80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PG_ADMIN_LOGIN:-admin@gmail.com}
      PGADMIN_DEFAULT_PASSWORD: ${PG_ADMIN_PASSWORD:-admin}
      SCRIPT_NAME: /pgadmin

volumes:
  pgdata:
  pgadmin-data:

networks:
  backend:
